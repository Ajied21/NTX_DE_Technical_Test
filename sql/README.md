# Channel Analysis, User Behavior Analysis, and Product Performance Analysis

This document outlines three SQL test cases designed to analyze channel performance, user behavior, and product performance using data from the `e_commerce_session` table. Each test case involves constructing SQL queries with Common Table Expressions (CTEs) to compute insights from e-commerce data effectively. Below are detailed descriptions of each test case along with the SQL queries.

---

## Test Case 1: Channel Analysis
This test case aims to analyze the revenue contribution of various channels across different countries. It involves calculating:
1. The total revenue generated by each country.
2. The revenue generated by each channel within each country.

### Query Description
1. **CountryRevenue CTE**:
   - Calculates the total transaction revenue for each country.
   - Sorts the countries by their total revenue in descending order.

2. **ChannelRevenue CTE**:
   - Calculates the total revenue for each channel grouping within each country.

3. **Main Query**:
   - Joins the `CountryRevenue` and `ChannelRevenue` CTEs to associate channel revenue with total country revenue.
   - Limits the output to the top 5 rows, sorted by country revenue and channel revenue in descending order.

```sql
WITH CountryRevenue AS (
    SELECT
        country,
        SUM("totalTransactionRevenue") AS total_revenue
    FROM e_commerce_session
    GROUP BY country
    ORDER BY total_revenue DESC
),
ChannelRevenue AS (
    SELECT
        "channelGrouping",
        country,
        SUM("totalTransactionRevenue") AS channel_revenue
    FROM e_commerce_session
    GROUP BY "channelGrouping", country
)
SELECT
    cr."channelGrouping",
    cr.country,
    cr.channel_revenue
FROM ChannelRevenue cr
INNER JOIN CountryRevenue ctry ON cr.country = ctry.country
ORDER BY ctry.total_revenue DESC, cr.channel_revenue DESC
LIMIT 5;
```

---

## Test Case 2: User Behavior Analysis
This test case focuses on understanding user behavior by analyzing metrics such as average time on site, average pageviews, and session quality.

### Query Description
1. **UserMetrics CTE**:
   - Computes average metrics (time on site, pageviews, session quality) for each visitor.
   - Excludes rows with `NULL` visitor IDs.

2. **GlobalAverages CTE**:
   - Calculates global averages for time on site and pageviews across all sessions.

3. **Main Query**:
   - Filters users whose average time on site exceeds the global average and whose average pageviews are below the global average.
   - Sorts results by average time on site in descending order.

```sql
WITH UserMetrics AS (
    SELECT
        "fullVisitorId",
        AVG("timeOnSite") AS avg_timeOnSite,
        AVG("pageviews") AS avg_pageviews,
        AVG("sessionQualityDim") AS avg_sessionQualityDim
    FROM e_commerce_session
    WHERE "fullVisitorId" IS NOT NULL
    GROUP BY "fullVisitorId"
),
GlobalAverages AS (
    SELECT
        AVG("timeOnSite") AS global_avg_timeOnSite,
        AVG("pageviews") AS global_avg_pageviews
    FROM e_commerce_session
)
SELECT
    um."fullVisitorId",
    um.avg_timeOnSite,
    um.avg_pageviews,
    um.avg_sessionQualityDim
FROM UserMetrics um
CROSS JOIN GlobalAverages ga
WHERE um.avg_timeOnSite > ga.global_avg_timeOnSite
  AND um.avg_pageviews < ga.global_avg_pageviews
ORDER BY um.avg_timeOnSite DESC;
```

---

## Test Case 3: Product Performance Analysis
This test case evaluates the performance of products in terms of revenue, sales, and refunds. It also flags products with significant refund rates.

### Query Description
1. **ProductPerformance CTE**:
   - Calculates total revenue, quantity sold, and total refund amount for each product.
   - Refund amount is computed based on specific action types.

2. **RankedProducts CTE**:
   - Computes net revenue (revenue after refunds) for each product.
   - Flags products where refunds exceed 10% of total revenue.

3. **Main Query**:
   - Selects product performance metrics, including the refund flag.
   - Sorts results by net revenue in descending order.

```sql
WITH ProductPerformance AS (
    SELECT
        "v2ProductName",
        SUM("totalTransactionRevenue") AS total_revenue,
        SUM(transactions) AS total_quantity_sold,
        SUM(CASE
            WHEN "eCommerceAction_type" = 2 THEN "productPrice" * "eCommerceAction_step"
            ELSE 0
        END) AS total_refund_amount
    FROM
       e_commerce_session
    GROUP BY
        "v2ProductName"
),
RankedProducts AS (
    SELECT
        "v2ProductName",
        total_revenue,
        total_quantity_sold,
        total_refund_amount,
        (total_revenue - total_refund_amount) AS net_revenue,
        CASE
            WHEN total_refund_amount > 0.1 * total_revenue THEN 'Flagged'
            ELSE 'OK'
        END AS refund_flag
    FROM
        ProductPerformance
)
SELECT
    "v2ProductName",
    total_revenue,
    total_quantity_sold,
    total_refund_amount,
    net_revenue,
    refund_flag
FROM
    RankedProducts
ORDER BY
    net_revenue DESC;
```

---

## Usage
These SQL queries can be used in a database environment to derive actionable insights from e-commerce data. Each query focuses on a specific aspect of performance or behavior, enabling data-driven decisions.

---

## Notes
- Ensure the `e_commerce_session` table contains all required columns and data before executing the queries.
- Adjust column names and table names if they differ in your database schema.
- For large datasets, consider optimizing queries or using indexes for better performance.